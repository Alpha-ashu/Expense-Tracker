// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id         String     @id @default(cuid())
  email      String     @unique
  name       String
  password   String
  role       String     @default("user")   // admin, advisor, user
  isApproved Boolean    @default(false)    // For advisor requests
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  refreshTokens        RefreshToken[]
  todos                Todo[]
  transactions         Transaction[]
  accounts             Account[]
  goals                Goal[]
  loans                Loan[]
  investments          Investment[]
  settings             UserSettings[]
  
  // Advisor relations
  bookingsAsAdvisor     BookingRequest[]  @relation("AdvisorBookings")
  bookingsAsClient      BookingRequest[]  @relation("ClientBookings")
  sessionsAsAdvisor     AdvisorSession[]  @relation("AdvisorSessions")
  sessionsAsClient      AdvisorSession[]  @relation("ClientSessions")
  sentMessages          ChatMessage[]
  advisorAvailability   AdvisorAvailability[]
  payments              Payment[] @relation("PaymentClient")
  advisorPayments       Payment[] @relation("PaymentAdvisor")
  notifications         Notification[]

  @@index([role])
  @@index([isApproved])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Todo {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Financial Models - All linked to User

model Account {
  id        String   @id @default(cuid())
  userId    String
  name      String
  type      String   @default("bank") // bank, card, cash, wallet
  balance   Float    @default(0)
  currency  String   @default("USD")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId])
  @@index([isActive])
}

model Transaction {
  id                   String   @id @default(cuid())
  userId               String
  accountId            String
  type                 String   // expense, income, transfer
  amount               Float
  category             String
  subcategory          String?
  description          String?
  merchant             String?
  date                 DateTime
  tags                 String? // stored as comma-separated string
  attachment           String?
  transferToAccountId  String?
  transferType         String?  // self-transfer, other-transfer
  synced               Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  deletedAt            DateTime?

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([accountId])
  @@index([date])
  @@index([category])
}

model Goal {
  id            String   @id @default(cuid())
  userId        String
  name          String
  targetAmount  Float
  currentAmount Float    @default(0)
  targetDate    DateTime
  category      String?
  isGroupGoal   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetDate])
}

model Loan {
  id                  String   @id @default(cuid())
  userId              String
  type                String   // borrowed, lent, emi
  name                String
  principalAmount     Float
  outstandingBalance  Float
  interestRate        Float?
  emiAmount           Float?
  dueDate             DateTime?
  frequency           String?  // monthly, weekly, custom
  status              String   @default("active") // active, overdue, completed
  contactPerson       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  deletedAt           DateTime?

  // Relations
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments  LoanPayment[]

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model LoanPayment {
  id        String   @id @default(cuid())
  loanId    String
  amount    Float
  accountId String?
  date      DateTime
  notes     String?
  createdAt DateTime @default(now())

  // Relations
  loan Loan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  @@index([loanId])
  @@index([date])
}

model Investment {
  id            String   @id @default(cuid())
  userId        String
  assetType     String   // stock, crypto, forex, gold, silver, other
  assetName     String
  quantity      Float
  buyPrice      Float
  currentPrice  Float
  totalInvested Float
  currentValue  Float
  profitLoss    Float
  purchaseDate  DateTime
  lastUpdated   DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assetType])
}

model UserSettings {
  id       String @id @default(cuid())
  userId   String @unique
  theme    String @default("light")
  language String @default("en")
  currency String @default("USD")
  timezone String @default("UTC")
  settings String @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Advisor Booking Models

model BookingRequest {
  id           String   @id @default(cuid())
  clientId     String
  advisorId    String
  sessionType  String          // video, phone, chat, inperson
  description  String?
  proposedDate DateTime
  proposedTime String          // HH:mm format
  duration     Int             // minutes
  amount       Float
  status       String   @default("pending") // pending, accepted, rejected, completed, cancelled
  rejectionReason String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  client   User            @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  advisor  User            @relation("AdvisorBookings", fields: [advisorId], references: [id], onDelete: Cascade)
  session  AdvisorSession?

  @@index([clientId])
  @@index([advisorId])
  @@index([status])
  @@index([proposedDate])
}

model AdvisorSession {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  advisorId  String
  clientId   String
  startTime  DateTime
  endTime    DateTime?
  sessionType String        // video, phone, chat, inperson
  status     String   @default("scheduled") // scheduled, in-progress, completed, cancelled
  notes      String?
  rating     Float?        // 1-5 stars
  feedback   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  booking      BookingRequest @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  advisor      User           @relation("AdvisorSessions", fields: [advisorId], references: [id], onDelete: Cascade)
  client       User           @relation("ClientSessions", fields: [clientId], references: [id], onDelete: Cascade)
  chatMessages ChatMessage[]
  payment      Payment?

  @@index([advisorId])
  @@index([clientId])
  @@index([status])
  @@index([startTime])
}

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  senderId  String
  message   String
  timestamp DateTime @default(now())

  // Relations
  session AdvisorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  sender  User           @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([senderId])
  @@index([timestamp])
}

model AdvisorAvailability {
  id        String   @id @default(cuid())
  advisorId String
  dayOfWeek Int      // 0 = Sunday, 6 = Saturday
  startTime String   // HH:mm
  endTime   String   // HH:mm
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  advisor User @relation(fields: [advisorId], references: [id], onDelete: Cascade)

  @@index([advisorId])
}

model Payment {
  id             String   @id @default(cuid())
  sessionId      String   @unique
  clientId       String
  advisorId      String
  amount         Float
  currency       String   @default("USD")
  status         String   @default("pending") // pending, completed, failed, refunded
  paymentMethod  String?  // stripe, razorpay, bank_transfer
  transactionId  String?  // External payment gateway ID
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  session AdvisorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  client  User           @relation("PaymentClient", fields: [clientId], references: [id], onDelete: Cascade)
  advisor User           @relation("PaymentAdvisor", fields: [advisorId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([advisorId])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id         String   @id @default(cuid())
  userId     String
  title      String
  message    String
  type       String   @default("info") // info, warning, error, success
  category   String?  // booking, payment, session, system
  deepLink   String?  // URL to navigate to when clicked
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  readAt     DateTime?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}